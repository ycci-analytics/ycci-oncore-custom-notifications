-- Notification audit table for initial alerts and weekly reminders.
-- Replace <SCHEMA_NAME> with your dev/prod schema before running.

CREATE TABLE <SCHEMA_NAME>.NOTIFICATION_AUDIT (
    AUDIT_ID             NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SENT_AT              TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
    JOB_CODE             VARCHAR2(128 CHAR) NOT NULL,
    EVENT_TYPE           VARCHAR2(64 CHAR) NOT NULL,
    VISIT_ID             VARCHAR2(128 CHAR),
    MODIFIED_USER_EMAIL  VARCHAR2(320 CHAR),
    DEDUPE_KEY           VARCHAR2(512 CHAR),
    JOB_RUN_ID           VARCHAR2(64 CHAR),
    ENVIRONMENT          VARCHAR2(16 CHAR) NOT NULL
);

COMMENT ON TABLE <SCHEMA_NAME>.NOTIFICATION_AUDIT IS
'Tracks notification sends for OnCore jobs (initial alerts and reminders).';

COMMENT ON COLUMN <SCHEMA_NAME>.NOTIFICATION_AUDIT.EVENT_TYPE IS
'Expected values include INITIAL_ALERT and WEEKLY_REMINDER.';

CREATE INDEX <SCHEMA_NAME>.IX_NOTIF_AUDIT_ENV_JOB_EVENT
    ON <SCHEMA_NAME>.NOTIFICATION_AUDIT (ENVIRONMENT, JOB_CODE, EVENT_TYPE, SENT_AT);

CREATE INDEX <SCHEMA_NAME>.IX_NOTIF_AUDIT_VISIT_USER
    ON <SCHEMA_NAME>.NOTIFICATION_AUDIT (VISIT_ID, MODIFIED_USER_EMAIL, SENT_AT);

CREATE INDEX <SCHEMA_NAME>.IX_NOTIF_AUDIT_DEDUPE
    ON <SCHEMA_NAME>.NOTIFICATION_AUDIT (DEDUPE_KEY);
